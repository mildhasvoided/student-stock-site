name: Queue Submission

on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      username:
        description: "GitHub username"
        required: false
      file_url:
        description: "URL to the uploaded file"
        required: false
      description:
        description: "Submission description"
        required: false

permissions:
  issues: read
  contents: write

jobs:
  queue:
    name: "📥 Queue a new submission"
    runs-on: ubuntu-latest
    steps:
      - name: 🛎️ Checkout repository
        uses: actions/checkout@v4

      - name: ⚙️ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Run when triggered by an Issue
      - name: 📝 Parse Issue submission
        if: github.event_name == 'issues'
        run: |
          echo "📬 Received submission from: ${{ github.actor }}"
          echo "📝 Issue body:"
          echo "${{ github.event.issue.body }}"
          node scripts/queue_submission.js
        env:
          USERNAME: ${{ github.actor }}
          ISSUE_BODY: ${{ github.event.issue.body }}

      # Run when triggered manually
      - name: 📝 Parse Manual submission
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "📬 Manual submission from: ${{ github.event.inputs.username }}"
          node scripts/queue_submission.js
        env:
          USERNAME: ${{ github.event.inputs.username }}
          FILE_URL: ${{ github.event.inputs.file_url }}
          DESCRIPTION: ${{ github.event.inputs.description }}

      - name: 💾 Commit queued submission
        run: |
          echo "📦 Saving queued submission to repo"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add submissions.json submissions_log
          git commit -m "Queue submission from ${{ github.actor }}" || echo "ℹ️ Nothing new to commit"
          git push
